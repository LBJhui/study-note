<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>8.Promiseä¸‹çš„ç‹¬ç«‹æ–¹æ³•</title>
  </head>
  <body></body>
  <!--
    Promise æ„é€ å‡½æ•°ä¸­æœ‰å¾ˆå¤šçš„æ–¹æ³•ï¼Œå…¶ä¸­åŒ…æ‹¬ resolveï¼Œreject...
    å…¶ä¸­ resolve æ–¹æ³•æ˜¯å¯ä»¥ä¼ é€’å‚æ•°çš„
    å‚æ•°åˆ†ä¸¤ç§æƒ…å†µï¼š
      é Promise å®ä¾‹åŒ–å¯¹è±¡ï¼šè¿”å›çš„æ˜¯ä¸€ä¸ªæˆåŠŸçš„ Promise å®ä¾‹åŒ–å¯¹è±¡
      æ˜¯ Promise å®ä¾‹åŒ–å¯¹è±¡

    Promise ä¸‹çš„ reject æ–¹æ³•ä¸åŒäº resolve æ–¹æ³•
    reject æ–¹æ³•æ˜¯ä¸å—å‚æ•°çš„å½±å“ï¼Œå°†å§‹ç»ˆè¿”å›ä¸€ä¸ªå¤±è´¥çš„ Promise å®ä¾‹åŒ–å¯¹è±¡

    Promise.all æ–¹æ³•éœ€è¦ä¼ é€’ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„
    æ•°ç»„é‡Œé¢æ˜¯éœ€è¦ä¼ å…¥ Promise å®ä¾‹åŒ–å¯¹è±¡
    Promise.all æ–¹æ³•è¿”å›çš„ä¹Ÿæ˜¯ä¸€ä¸ª Promise å®ä¾‹åŒ–å¯¹è±¡
    å½“å¦‚æœæ‰€æœ‰çš„ Promise å®ä¾‹åŒ–å¯¹è±¡çš„çŠ¶æ€éƒ½æ˜¯æˆåŠŸçš„è¯ï¼Œåˆ™è¿”å›çš„æ–°çš„ Promise å®ä¾‹åŒ–å¯¹è±¡çŠ¶æ€ä¹Ÿæ˜¯æˆåŠŸçš„ï¼Œç»“æœå€¼å°±æ˜¯æ‰€æœ‰æˆåŠŸçš„ Promise å®ä¾‹åŒ–å¯¹è±¡çš„ç»“æœå€¼ç»„æˆçš„æ•°ç»„
    å½“å¦‚æœè¿™äº› Promise å®ä¾‹åŒ–å¯¹è±¡å…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯å¤±è´¥çš„èŠ±ï¼Œåˆ™ç›´æ¥è¿”å›çš„æ˜¯å¤±è´¥çš„ Promise å®ä¾‹åŒ–å¯¹è±¡ï¼Œç»“æœå€¼å°±æ˜¯å¤±è´¥çš„è¿™ä¸ª Promise å®ä¾‹åŒ–å¯¹è±¡çš„ç»“æœå€¼

    Promise.race æ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ªå‚æ•°ï¼Œå‚æ•°è¿˜æ˜¯ä¸€ä¸ªæ•°ç»„
    å’Œ all æ–¹æ³•ä¸åŒçš„åœ°æ–¹ï¼Œæ˜¯æ•°ç»„ä¸­çš„å“ªä¸€ä¸ª Promise å®ä¾‹åŒ–å¯¹è±¡çš„çŠ¶æ€ä¼˜å…ˆä» pending æ”¹å˜æˆäº† fulfilled æˆ–è€…ä» pending æ”¹å˜æˆäº† rejectedï¼Œåˆ™è¿™ä¸ªä¼˜å…ˆæ”¹å˜çš„ Promise å®ä¾‹åŒ–å¯¹è±¡çš„çŠ¶æ€å’Œç»“æœå€¼å°†å†³å®šæœ€ç»ˆçš„ Promise çŠ¶æ€å’Œç»“æœå€¼
    race çš„è¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹åŒ–å¯¹è±¡
  -->
  <script>
    // ç«‹å³æ‰§è¡Œå‡½æ•°ï¼ˆIIFEï¼‰
    // å¥½å¤„ï¼šå¯ä»¥é¿å…å †å¤–éƒ¨çš„å˜é‡é€ æˆæ±¡æŸ“
    ;(function (window) {
      // åªè¦æ˜¯ç»™æ„é€ å‡½æ•°çš„å®ä¾‹åŒ–å¯¹è±¡èº«ä¸Šæ·»åŠ å±æ€§/æ–¹æ³•ï¼Œé‚£ä¹ˆç›´æ¥åœ¨å‡½æ•°ä¸­ this å¯¹è±¡çš„åœ°å€å¼•ç”¨èº«ä¸Šç›´æ¥æ·»åŠ 
      function Promise(executor) {
        // ç»™ Promise æ„é€ å‡½æ•°æ‰€äº§ç”Ÿçš„å®ä¾‹åŒ–å¯¹è±¡èº«ä¸Šæ·»åŠ å±æ€§
        this.PromiseState = 'pending'
        this.PromiseResult = undefined
        this.callbackFn = []
        // æ–¹æ³•1ï¼šå¯ä»¥ä¿å­˜æƒ³è¦çš„å‡½æ•°ä¸­ this æŒ‡å‘ï¼Œåœ¨å“ªä¸€ä¸ªéœ€è¦çš„å‡½æ•°è¿›è¡Œç›´æ¥ä½¿ç”¨å³å¯
        // å®šä¹‰ resolve å‡½æ•°
        // ç®­å¤´å‡½æ•°æ˜¯æ²¡æœ‰è‡ªå·±çš„ this æŒ‡å‘çš„ï¼Œå–å†³äºå½“å‰å‡½æ•°æ‰€å£°æ˜çš„ä½ç½®çš„ this æŒ‡å‘ï¼ˆå¤–å±‚å‡½æ•°ä¸­çš„ this æŒ‡å‘ï¼‰
        const _resolve = (value) => {
          // åªè¦å½“å‰ Promise å®ä¾‹åŒ–å¯¹è±¡çš„çŠ¶æ€ä¸æ˜¯ pendingï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½å·²ç»æ˜¯ fulfilled æˆ–è€…æ˜¯ rejected
          // æ‰€ä»¥å°±ä¸å†æ›´æ”¹äº†ï¼Œåªè¦è¿˜ä¸º pending å°±æœ‰å¯èƒ½æ ¹æ®è°ƒç”¨ä¸åŒçš„æ–¹æ³•æ¥è¿›è¡Œæ›´æ”¹çŠ¶æ€
          if (this.PromiseState !== 'pending') return
          this.PromiseState = 'fulfilled'
          this.PromiseResult = value
          // æ‰§è¡Œå½“ Promise å®ä¾‹åŒ–å¯¹è±¡çš„çŠ¶æ€ä¸º pending çš„æ—¶å€™ï¼Œå›è°ƒå‡½æ•°
          this.callbackFn.forEach((item) => {
            item.onfulfilled()
          })
        }
        // å®šä¹‰ reject å‡½æ•°
        const _reject = (value) => {
          if (this.PromiseState !== 'pending') return
          this.PromiseState = 'rejected'
          this.PromiseResult = value
          this.callbackFn.forEach((item) => {
            item.onrejected()
          })
        }
        try {
          executor(_resolve, _reject)
        } catch (error) {
          if (this.PromiseState !== 'pending') return
          typeof error === 'object' ? (this.PromiseResult = error.message) : (this.PromiseResult = error)
          this.PromiseState = 'rejected'
        }
      }
      // å€ŸåŠ© Object.assign æ–¹æ³•ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡å’Œ prototype å¯¹è±¡è¿›è¡Œåˆå¹¶
      Object.assign(Promise.prototype, {
        // onfulfilled æˆåŠŸçš„å›è°ƒå‡½æ•°
        // onrejected å¤±è´¥çš„å›è°ƒå‡½æ•°
        // æ–¹æ³•ä¸­çš„ this å–å†³äºæ–¹æ³•çš„è°ƒç”¨è€…ï¼Œè°è°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆå‡½æ•°ä¸­çš„ this å°±æŒ‡å‘å“ªä¸€ä¸ªå¯¹è±¡
        then(onfulfilled, onrejected) {
          // å¦‚æœæˆåŠŸçš„å›è°ƒå‡½æ•°å¹¶ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™å¢åŠ ï¼ˆè¡¥å……ï¼‰æˆåŠŸçš„å›è°ƒå‡½æ•°é»˜è®¤å€¼
          if (!(onfulfilled instanceof Function)) {
            onfulfilled = (value) => value
          }
          // å¦‚æœå¤±è´¥çš„å›è°ƒå‡½æ•°å¹¶ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™å¢åŠ ï¼ˆè¡¥å……ï¼‰å¤±è´¥çš„å›è°ƒå‡½æ•°é»˜è®¤å€¼
          if (!(onrejected instanceof Function)) {
            onrejected = (reason) => {
              throw reason
            }
          }

          // è°ƒç”¨ then  æ–¹æ³•ä¼šå¾—åˆ°ä¸€ä¸ªè¿”å›å€¼ï¼Œä¸ºæ–°çš„ Promise å®ä¾‹åŒ–å¯¹è±¡
          return new Promise((resolve, reject) => {
            // å°è£…å‡½æ•°
            const _common = function (callback) {
              setTimeout(() => {
                try {
                  const value = callback(this.PromiseResult)
                  if (value instanceof Promise) {
                    value.then(resolve, reject)
                  } else {
                    resolve(value)
                  }
                } catch (error) {
                  reject(error)
                }
              })
            }
            // åˆ¤æ–­
            if (this.PromiseState === 'fulfilled') {
              // è°ƒç”¨æˆåŠŸæ—¶å€™çš„å›è°ƒå‡½æ•°
              // ç«‹å³æ‰§è¡Œï¼Œç«‹å³è°ƒç”¨
              // å¦‚æœæƒ³è¦è®©æˆåŠŸçš„å›è°ƒå‡½æ•°æ…¢äºåŒæ­¥æ‰§è¡Œçš„ä»£ç ï¼Œåªéœ€è¦è°ƒç”¨å®šæ—¶å™¨å³å¯
              // å¼‚æ­¥è°ƒç”¨
              // è°ƒç”¨å…¬å…±çš„å°è£…å‡½æ•°
              _common.call(this, onfulfilled)
            } else if (this.PromiseState === 'rejected') {
              // è°ƒç”¨å¤±è´¥æ—¶å€™çš„å›è°ƒå‡½æ•°
              _common.call(this, onrejected)
            } else {
              // å¦‚æœ executor æ‰§è¡Œå™¨å‡½æ•°å½“ä¸­æ‰§è¡Œçš„æ˜¯å¼‚æ­¥ç¨‹åº
              // å½“ç»“æœè¿˜æ²¡æœ‰å®Œå…¨æ‰§è¡Œå®Œæ¯•ï¼ˆæ—¶é—´è¿˜æ²¡æœ‰å®Œå…¨åˆ°è¾¾ï¼‰
              // æ­¤æ—¶ Promise å®ä¾‹åŒ–å¯¹è±¡çš„çŠ¶æ€ä¸º pending çš„çŠ¶æ€
              this.callbackFn.push({
                // æ·»åŠ ä¸¤ä¸ªå›è°ƒå‡½æ•°
                onfulfilled: _common.bind(this, onfulfilled),
                onrejected: _common.bind(this, onrejected),
              })
            }
          })
        },
        catch(onrejected) {
          return this.then(undefined, onrejected)
        },
      })
      // ç»™ Promise æ„é€ å‡½æ•°ä¸­æ·»åŠ ä¸€äº›æ–¹æ³•
      Promise.resolve = function (value) {
        // æ ¹æ®ä¼ é€’çš„å®é™…å‚æ•°åˆ°åº•æ˜¯ä¸æ˜¯ Promise çš„å®ä¾‹åŒ–å¯¹è±¡æ¥åˆ¤æ–­
        if (value instanceof Promise) {
          return value
        } else {
          return new Promise((resolve) => {
            resolve(value)
          })
        }
      }
      Promise.reject = function (value) {
        return new Promise((resolve, reject) => {
          reject(value)
        })
      }
      Promise.all = function (PromiseArr) {
        // å®šä¹‰ä¸€ä¸ªè®¡æ•°çš„å˜é‡
        let index = 0
        // å®šä¹‰ä¸€ä¸ªç©ºæ•°ç»„ï¼Œç”¨æ¥æ·»åŠ æ‰€æœ‰æˆåŠŸçš„ Promise å®ä¾‹åŒ–å¯¹è±¡
        let successArr = new Array(PromiseArr.length)
        return new Promise((resolve, reject) => {
          // forEach å›è°ƒå‡½æ•°çš„å‚æ•°
          // ç¬¬ä¸€ä¸ªå‚æ•°ï¼šæ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå€¼
          // ç¬¬äºŒä¸ªå‚æ•°ï¼šæ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå€¼çš„ä¸‹æ ‡
          PromiseArr.forEach((value, i) => {
            value.then(
              (v) => {
                // æ—¢ç„¶èƒ½å¤Ÿèµ°åˆ°æˆåŠŸçš„å›è°ƒå‡½æ•°ï¼Œè¯æ˜å·²ç»æ˜¯æˆåŠŸçš„ Promiseï¼Œæ‰€ä»¥è¦ç®—ä¸€ä¸ª
                index++
                successArr[i] = v
                // å½“è®¡æ•°çš„æ•°é‡å’Œå®é™…æ•°ç»„çš„æ•°é‡ç›¸åŒï¼Œè¯æ˜æ¯ä¸€ä¸ª Promise éƒ½æ˜¯æˆåŠŸçš„
                if (index === PromiseArr.length) {
                  resolve(successArr)
                }
              },
              (reason) => {
                // æœ‰ä¸€ä¸ªå¤±è´¥çš„ Promise å®ä¾‹åŒ–å¯¹è±¡ï¼Œåˆ™æ•´ä½“å°±æ˜¯ä¸€ä¸ªå¤±è´¥ Promise
                reject(reason)
              }
            )
          })
        })
      }
      Promise.race = function (PromiseArr) {
        return new Promise((resolve, reject) => {
          PromiseArr.forEach((value) => {
            value.then(resolve, reject)
          })
        })
      }
      window.Promise = Promise
    })(window)
  </script>
  <script>
    const p1 = Promise.resolve(1)
    console.log('%c Line:119 ğŸ¥’ p1', 'font-size:16px;color:#f5ce50', p1)
    const p2 = Promise.resolve(
      new Promise((resolve, reject) => {
        resolve(2)
      })
    )
    console.log('%c Line:125 ğŸ¥ª p2', 'font-size:16px;color:#6ec1c2', p2)
    const p3 = Promise.resolve(
      new Promise((resolve, reject) => {
        reject(3)
      })
    )
    console.log('%c Line:152 ğŸ” p3', 'font-size:16px;color:#ea7e5c', p3)
  </script>
</html>
