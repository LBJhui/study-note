<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>6.æŒ‡å®šå¤šä¸ªæˆåŠŸæˆ–è€…å¤±è´¥çš„å›è°ƒ</title>
  </head>
  <body></body>
  <script>
    // ç«‹å³æ‰§è¡Œå‡½æ•°ï¼ˆIIFEï¼‰
    // å¥½å¤„ï¼šå¯ä»¥é¿å…å †å¤–éƒ¨çš„å˜é‡é€ æˆæ±¡æŸ“
    ;(function (window) {
      // åªè¦æ˜¯ç»™æ„é€ å‡½æ•°çš„å®ä¾‹åŒ–å¯¹è±¡èº«ä¸Šæ·»åŠ å±æ€§/æ–¹æ³•ï¼Œé‚£ä¹ˆç›´æ¥åœ¨å‡½æ•°ä¸­ this å¯¹è±¡çš„åœ°å€å¼•ç”¨èº«ä¸Šç›´æ¥æ·»åŠ 
      function Promise(executor) {
        // ç»™ Promise æ„é€ å‡½æ•°æ‰€äº§ç”Ÿçš„å®ä¾‹åŒ–å¯¹è±¡èº«ä¸Šæ·»åŠ å±æ€§
        this.PromiseState = 'pending'
        this.PromiseResult = undefined
        this.callbackFn = []
        // æ–¹æ³•1ï¼šå¯ä»¥ä¿å­˜æƒ³è¦çš„å‡½æ•°ä¸­ this æŒ‡å‘ï¼Œåœ¨å“ªä¸€ä¸ªéœ€è¦çš„å‡½æ•°è¿›è¡Œç›´æ¥ä½¿ç”¨å³å¯
        // å®šä¹‰ resolve å‡½æ•°
        // ç®­å¤´å‡½æ•°æ˜¯æ²¡æœ‰è‡ªå·±çš„ this æŒ‡å‘çš„ï¼Œå–å†³äºå½“å‰å‡½æ•°æ‰€å£°æ˜çš„ä½ç½®çš„ this æŒ‡å‘ï¼ˆå¤–å±‚å‡½æ•°ä¸­çš„ this æŒ‡å‘ï¼‰
        const _resolve = (value) => {
          // åªè¦å½“å‰ Promise å®ä¾‹åŒ–å¯¹è±¡çš„çŠ¶æ€ä¸æ˜¯ pendingï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½å·²ç»æ˜¯ fulfilled æˆ–è€…æ˜¯ rejected
          // æ‰€ä»¥å°±ä¸å†æ›´æ”¹äº†ï¼Œåªè¦è¿˜ä¸º pending å°±æœ‰å¯èƒ½æ ¹æ®è°ƒç”¨ä¸åŒçš„æ–¹æ³•æ¥è¿›è¡Œæ›´æ”¹çŠ¶æ€
          if (this.PromiseState !== 'pending') return
          this.PromiseState = 'fulfilled'
          this.PromiseResult = value
          // æ‰§è¡Œå½“ Promise å®ä¾‹åŒ–å¯¹è±¡çš„çŠ¶æ€ä¸º pending çš„æ—¶å€™ï¼Œå›è°ƒå‡½æ•°
          this.callbackFn.forEach((item) => {
            item.onfulfilled()
          })
        }
        // å®šä¹‰ reject å‡½æ•°
        const _reject = (value) => {
          if (this.PromiseState !== 'pending') return
          this.PromiseState = 'rejected'
          this.PromiseResult = value
          this.callbackFn.forEach((item) => {
            item.onrejected()
          })
        }
        try {
          executor(_resolve, _reject)
        } catch (error) {
          if (this.PromiseState !== 'pending') return
          typeof error === 'object' ? (this.PromiseResult = error.message) : (this.PromiseResult = error)
          this.PromiseState = 'rejected'
        }
      }
      // å€ŸåŠ© Object.assign æ–¹æ³•ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡å’Œ prototype å¯¹è±¡è¿›è¡Œåˆå¹¶
      Object.assign(Promise.prototype, {
        // onfulfilled æˆåŠŸçš„å›è°ƒå‡½æ•°
        // onrejected å¤±è´¥çš„å›è°ƒå‡½æ•°
        // æ–¹æ³•ä¸­çš„ this å–å†³äºæ–¹æ³•çš„è°ƒç”¨è€…ï¼Œè°è°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆå‡½æ•°ä¸­çš„ this å°±æŒ‡å‘å“ªä¸€ä¸ªå¯¹è±¡
        then(onfulfilled, onrejected) {
          // å¦‚æœæˆåŠŸçš„å›è°ƒå‡½æ•°å¹¶ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™å¢åŠ ï¼ˆè¡¥å……ï¼‰æˆåŠŸçš„å›è°ƒå‡½æ•°é»˜è®¤å€¼
          if (!(onfulfilled instanceof Function)) {
            onfulfilled = (value) => value
          }
          // å¦‚æœå¤±è´¥çš„å›è°ƒå‡½æ•°å¹¶ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™å¢åŠ ï¼ˆè¡¥å……ï¼‰å¤±è´¥çš„å›è°ƒå‡½æ•°é»˜è®¤å€¼
          if (!(onrejected instanceof Function)) {
            onrejected = (reason) => {
              throw reason
            }
          }

          // è°ƒç”¨ then  æ–¹æ³•ä¼šå¾—åˆ°ä¸€ä¸ªè¿”å›å€¼ï¼Œä¸ºæ–°çš„ Promise å®ä¾‹åŒ–å¯¹è±¡
          return new Promise((resolve, reject) => {
            // å°è£…å‡½æ•°
            const _common = function (callback) {
              setTimeout(() => {
                try {
                  const value = callback(this.PromiseResult)
                  if (value instanceof Promise) {
                    value.then(resolve, reject)
                  } else {
                    resolve(value)
                  }
                } catch (error) {
                  reject(error)
                }
              })
            }
            // åˆ¤æ–­
            if (this.PromiseState === 'fulfilled') {
              // è°ƒç”¨æˆåŠŸæ—¶å€™çš„å›è°ƒå‡½æ•°
              // ç«‹å³æ‰§è¡Œï¼Œç«‹å³è°ƒç”¨
              // å¦‚æœæƒ³è¦è®©æˆåŠŸçš„å›è°ƒå‡½æ•°æ…¢äºåŒæ­¥æ‰§è¡Œçš„ä»£ç ï¼Œåªéœ€è¦è°ƒç”¨å®šæ—¶å™¨å³å¯
              // å¼‚æ­¥è°ƒç”¨
              // è°ƒç”¨å…¬å…±çš„å°è£…å‡½æ•°
              _common.call(this, onfulfilled)
            } else if (this.PromiseState === 'rejected') {
              // è°ƒç”¨å¤±è´¥æ—¶å€™çš„å›è°ƒå‡½æ•°
              _common.call(this, onrejected)
            } else {
              // å¦‚æœ executor æ‰§è¡Œå™¨å‡½æ•°å½“ä¸­æ‰§è¡Œçš„æ˜¯å¼‚æ­¥ç¨‹åº
              // å½“ç»“æœè¿˜æ²¡æœ‰å®Œå…¨æ‰§è¡Œå®Œæ¯•ï¼ˆæ—¶é—´è¿˜æ²¡æœ‰å®Œå…¨åˆ°è¾¾ï¼‰
              // æ­¤æ—¶ Promise å®ä¾‹åŒ–å¯¹è±¡çš„çŠ¶æ€ä¸º pending çš„çŠ¶æ€
              this.callbackFn.push({
                // æ·»åŠ ä¸¤ä¸ªå›è°ƒå‡½æ•°
                onfulfilled: _common.bind(this, onfulfilled),
                onrejected: _common.bind(this, onrejected),
              })
            }
          })
        },
      })
      window.Promise = Promise
    })(window)
  </script>
  <script>
    let p = new Promise((resolve, reject) => {
      resolve(100)
    })
    const p2 = p.then()
    const p3 = p.then()
    const p4 = p.then()
    const p5 = p.then()
    console.log('%c Line:106 ğŸ© p2', 'font-size:16px;color:#33a5ff', p2)
    console.log('%c p3', 'font-size:16px;color:#33a5ff', p3)
  </script>
</html>
