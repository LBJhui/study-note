<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>5.thenå‡½æ•°</title>
  </head>
  <body></body>
  <!--
    1. ä»»ä½•çš„å®ä¾‹åŒ–å¯¹è±¡çš„ __proto__ï¼ˆéšå¼åŸå‹å±æ€§ï¼‰çš„å€¼å’Œæ„é€ å‡½æ•°ä¸­çš„ prototypeï¼ˆæ˜¾ç¤ºåŸå‹å±æ€§ï¼‰çš„å€¼ç›¸åŒçš„
    2. ä»»ä½•çš„å‡½æ•°ä¸­çš„ prototype çš„å€¼éƒ½æŒ‡å‘ Object ç±»å‹çš„å¯¹è±¡çš„åœ°å€å€¼
    3. object.assign æ–¹æ³•æ˜¯å¯¹è±¡é—´çš„åˆå¹¶çš„æ–¹æ³•
  -->
  <!--
    then å‡½æ•°æ˜¯æœ‰è¿”å›å€¼çš„ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹åŒ–å¯¹è±¡
    æ–°çš„ Promise å®ä¾‹åŒ–å¯¹è±¡çš„çŠ¶æ€å–å†³äº p å®ä¾‹åŒ–å¯¹è±¡çš„çŠ¶æ€
    å¦‚æœ p è¿™ä¸ªå¯¹è±¡çš„æ˜¯æˆåŠŸçš„çŠ¶æ€ï¼Œåˆ™æ‰§è¡Œ then çš„æˆåŠŸå›è°ƒå‡½æ•°
    å¦‚æœ p è¿™ä¸ªå¯¹è±¡çš„æ˜¯å¤±è´¥çš„çŠ¶æ€ï¼Œåˆ™æ‰§è¡Œ then çš„å¤±è´¥å›è°ƒå‡½æ•°

    å¦‚æœæ‰§è¡Œ then æˆåŠŸå›è°ƒå‡½æ•°ï¼Œè¿˜æ˜¯éœ€è¦çœ‹è¿™ä¸ªå›è°ƒå‡½æ•°ä¸­çš„å†…å®¹
    å¦‚æœæ²¡æœ‰è¿”å›å€¼ï¼Œåˆ™æ˜¯ä¸€ä¸ªæˆåŠŸçš„ Promiseï¼Œå¹¶ä¸”ç»“æœå€¼ä¸º undefined
    å¦‚æœç¡®å®šæœ‰è¿”å›å€¼ï¼Œè¿˜æ˜¯éœ€è¦çœ‹è¿”å›çš„åˆ°åº•æ˜¯ä»€ä¹ˆ
      å¦‚æœè¿”å›çš„ä¸ºé Promise å®ä¾‹åŒ–å¯¹è±¡ï¼Œåˆ™çŠ¶æ€ä»ç„¶æ˜¯æˆåŠŸçš„ Promise å®ä¾‹åŒ–ä¸œè¥¿ï¼Œè¿”å›å€¼å°±æ˜¯ç»“æœå€¼
      å¦‚æœè¿”å›çš„ä¸º Promise å®ä¾‹åŒ–å¯¹è±¡ï¼Œåˆ™è¿”å›çš„è¿™ä¸ª Promise å®ä¾‹åŒ–å¯¹è±¡çš„çŠ¶æ€æ˜¯ä»€ä¹ˆï¼Œp2 å®ä¾‹åŒ–å¯¹è±¡çš„çŠ¶æ€å°±æ˜¯ä»€ä¹ˆ
      å¦‚æœç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™è¿”å›çš„æ˜¯ä¸€ä¸ªå¤±è´¥çš„ Promise å®ä¾‹åŒ–å¯¹è±¡
  -->
  <!--
    1. then æ–¹æ³•å¦‚æœçœç•¥äº†æˆåŠŸçš„å›è°ƒå‡½æ•°ï¼Œåˆ™é»˜è®¤æˆåŠŸçš„å›è°ƒå‡½æ•°ä¸º value=>value
    2. then æ–¹æ³•å¦‚æœçœç•¥äº†å¤±è´¥çš„å›è°ƒå‡½æ•°ï¼Œåˆ™é»˜è®¤å¤±è´¥çš„å›è°ƒå‡½æ•°ä¸º reason=>{throw reason}
  -->
  <script>
    // ç«‹å³æ‰§è¡Œå‡½æ•°ï¼ˆIIFEï¼‰
    // å¥½å¤„ï¼šå¯ä»¥é¿å…å †å¤–éƒ¨çš„å˜é‡é€ æˆæ±¡æŸ“
    ;(function (window) {
      // åªè¦æ˜¯ç»™æ„é€ å‡½æ•°çš„å®ä¾‹åŒ–å¯¹è±¡èº«ä¸Šæ·»åŠ å±æ€§/æ–¹æ³•ï¼Œé‚£ä¹ˆç›´æ¥åœ¨å‡½æ•°ä¸­ this å¯¹è±¡çš„åœ°å€å¼•ç”¨èº«ä¸Šç›´æ¥æ·»åŠ 
      function Promise(executor) {
        // ç»™ Promise æ„é€ å‡½æ•°æ‰€äº§ç”Ÿçš„å®ä¾‹åŒ–å¯¹è±¡èº«ä¸Šæ·»åŠ å±æ€§
        this.PromiseState = 'pending'
        this.PromiseResult = undefined
        this.callbackFn = {}
        // æ–¹æ³•1ï¼šå¯ä»¥ä¿å­˜æƒ³è¦çš„å‡½æ•°ä¸­ this æŒ‡å‘ï¼Œåœ¨å“ªä¸€ä¸ªéœ€è¦çš„å‡½æ•°è¿›è¡Œç›´æ¥ä½¿ç”¨å³å¯
        let _this = this
        /**
         *  å‡½æ•°ä¸­çš„ thisæŒ‡å‘å–å†³äºå‡½æ•°çš„è°ƒç”¨è€…ï¼Œä¹Ÿå°±æ˜¯è¯´è°è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆå‡½æ•°ä¸­çš„ this å°±æŒ‡å‘è°
         *  å‡½æ•°ä¸­ this ä¸å…‰å¯ä»¥å¾—åˆ°å¦ä¸€ä¸ªå‡½æ•°ä¸­çš„ this æŒ‡å‘ï¼Œè¿˜å¯ä»¥ç›´æ¥ä¿®æ”¹æˆæƒ³è¦çš„ this æŒ‡å‘
         *  ä¿®æ”¹å‡½æ•°ä¸­çš„ this æŒ‡å‘ï¼šcallã€applyã€bind
         *    call å’Œ apply ä¹‹é—´çš„åŒºåˆ«ï¼šåœ¨äºå‡½æ•°ä¸­ä¿®æ”¹å®Œ this æŒ‡å‘ï¼Œå®é™…å‚æ•°ä¼ é€’çš„æ ¼å¼ä¸åŒ
         *      è¯­æ³•ï¼š
         *          å‡½æ•°å.call(æ–°çš„thisæŒ‡å‘, å®é™…å‚æ•°1,å®é™…å‚æ•°2)
         *          å‡½æ•°å.apply(æ–°çš„thisæŒ‡å‘, [å®é™…å‚æ•°1, å®é™…å‚æ•°2...])
         *    call å’Œ apply ä¹‹é—´çš„å…±åŒç‚¹ï¼šåœ¨äºå‡½æ•°ä¸€æ—¦ä¿®æ”¹å®Œæƒ³è¦çš„ this æŒ‡å‘ä¹‹åï¼Œåˆ™å‡½æ•°å°±ä¼šç«‹å³æ‰§è¡Œ
         *
         *    call å’Œ bind ä¹‹é—´çš„åŒºåˆ«ï¼šcall ä¼šç«‹å³æ‰§è¡Œï¼Œbind ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œä¸” bind åªæœ‰è¿”å›å€¼ï¼Œä¸”è¿”å›çš„æ˜¯ä¸åŸå‡½æ•°ç»“æ„ä¸€æ¨¡ä¸€æ ·çš„ä¿®æ”¹å®Œ this æŒ‡å‘çš„æ–°å‡½æ•°
         */
        // å®šä¹‰ resolve å‡½æ•°
        // ç®­å¤´å‡½æ•°æ˜¯æ²¡æœ‰è‡ªå·±çš„ this æŒ‡å‘çš„ï¼Œå–å†³äºå½“å‰å‡½æ•°æ‰€å£°æ˜çš„ä½ç½®çš„ this æŒ‡å‘ï¼ˆå¤–å±‚å‡½æ•°ä¸­çš„ this æŒ‡å‘ï¼‰
        const _resolve = (value) => {
          // åªè¦å½“å‰ Promise å®ä¾‹åŒ–å¯¹è±¡çš„çŠ¶æ€ä¸æ˜¯ pendingï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½å·²ç»æ˜¯ fulfilled æˆ–è€…æ˜¯ rejected
          // æ‰€ä»¥å°±ä¸å†æ›´æ”¹äº†ï¼Œåªè¦è¿˜ä¸º pending å°±æœ‰å¯èƒ½æ ¹æ®è°ƒç”¨ä¸åŒçš„æ–¹æ³•æ¥è¿›è¡Œæ›´æ”¹çŠ¶æ€
          if (this.PromiseState !== 'pending') return
          this.PromiseState = 'fulfilled'
          this.PromiseResult = value
          // æ‰§è¡Œå½“ Promise å®ä¾‹åŒ–å¯¹è±¡çš„çŠ¶æ€ä¸º pending çš„æ—¶å€™ï¼Œå›è°ƒå‡½æ•°
          if (this.callbackFn.onfulfilled) {
            this.callbackFn.onfulfilled()
          }
        }
        // å®šä¹‰ reject å‡½æ•°
        const _reject = (value) => {
          if (this.PromiseState !== 'pending') return
          this.PromiseState = 'rejected'
          this.PromiseResult = value
          if (this.callbackFn.onrejected) {
            this.callbackFn.onrejected()
          }
        }
        try {
          executor(_resolve, _reject)
        } catch (error) {
          if (this.PromiseState !== 'pending') return
          typeof error === 'object' ? (this.PromiseResult = error.message) : (this.PromiseResult = error)
          this.PromiseState = 'rejected'
        }
      }
      // å€ŸåŠ© Object.assign æ–¹æ³•ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡å’Œ prototype å¯¹è±¡è¿›è¡Œåˆå¹¶
      Object.assign(Promise.prototype, {
        // onfulfilled æˆåŠŸçš„å›è°ƒå‡½æ•°
        // onrejected å¤±è´¥çš„å›è°ƒå‡½æ•°
        // æ–¹æ³•ä¸­çš„ this å–å†³äºæ–¹æ³•çš„è°ƒç”¨è€…ï¼Œè°è°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆå‡½æ•°ä¸­çš„ this å°±æŒ‡å‘å“ªä¸€ä¸ªå¯¹è±¡
        then(onfulfilled, onrejected) {
          // å¦‚æœæˆåŠŸçš„å›è°ƒå‡½æ•°å¹¶ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™å¢åŠ ï¼ˆè¡¥å……ï¼‰æˆåŠŸçš„å›è°ƒå‡½æ•°é»˜è®¤å€¼
          if (!(onfulfilled instanceof Function)) {
            onfulfilled = (value) => value
          }
          // å¦‚æœå¤±è´¥çš„å›è°ƒå‡½æ•°å¹¶ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™å¢åŠ ï¼ˆè¡¥å……ï¼‰å¤±è´¥çš„å›è°ƒå‡½æ•°é»˜è®¤å€¼
          if (!(onrejected instanceof Function)) {
            onrejected = (reason) => {
              throw reason
            }
          }

          // è°ƒç”¨ then  æ–¹æ³•ä¼šå¾—åˆ°ä¸€ä¸ªè¿”å›å€¼ï¼Œä¸ºæ–°çš„ Promise å®ä¾‹åŒ–å¯¹è±¡
          return new Promise((resolve, reject) => {
            // å°è£…å‡½æ•°
            const _common = function (callback) {
              setTimeout(() => {
                try {
                  const value = callback(this.PromiseResult)
                  if (value instanceof Promise) {
                    value.then(resolve, reject)
                  } else {
                    resolve(value)
                  }
                } catch (error) {
                  reject(error)
                }
              })
            }
            // åˆ¤æ–­
            if (this.PromiseState === 'fulfilled') {
              // è°ƒç”¨æˆåŠŸæ—¶å€™çš„å›è°ƒå‡½æ•°
              // ç«‹å³æ‰§è¡Œï¼Œç«‹å³è°ƒç”¨
              // å¦‚æœæƒ³è¦è®©æˆåŠŸçš„å›è°ƒå‡½æ•°æ…¢äºåŒæ­¥æ‰§è¡Œçš„ä»£ç ï¼Œåªéœ€è¦è°ƒç”¨å®šæ—¶å™¨å³å¯
              // å¼‚æ­¥è°ƒç”¨
              /*
                setTimeout(() => {
                  try {
                    // æ¥æ”¶æˆåŠŸçš„å›è°ƒå‡½æ•°çš„ç»“æœ
                    const value = onfulfilled(this.PromiseResult)
                    // åˆ¤æ–­ value æ˜¯ä¸æ˜¯ Promise çš„å®ä¾‹åŒ–å¯¹è±¡

                    if (value instanceof Promise) {
                      // value.then(
                      //   (v) => {
                      //     resolve(v)
                      //   },
                      //   (r) => {
                      //     reject(r)
                      //   }
                      // )
                      value.then(resolve, reject)
                    } else {
                      // ä¸æ˜¯è¿”å›çš„ Promise å®ä¾‹åŒ–å¯¹è±¡
                      // å°†è¿”å›çš„ç»“æœç›´æ¥ä½œä¸º resolve è¿™ä¸ªæ–¹æ³•çš„å®é™…å‚æ•°
                      resolve(value)
                    }
                  } catch (error) {
                    // å¦‚æœæœ‰å¼‚å¸¸ï¼Œåˆ™ç›´æ¥è¿”å›å¤±è´¥çš„ Promise å®ä¾‹åŒ–å¯¹è±¡ï¼Œç»“æœå€¼ä¸º err å‚æ•°
                    reject(error)
                  }
                })
              */
              // è°ƒç”¨å…¬å…±çš„å°è£…å‡½æ•°
              _common.call(this, onfulfilled)
            } else if (this.PromiseState === 'rejected') {
              // è°ƒç”¨å¤±è´¥æ—¶å€™çš„å›è°ƒå‡½æ•°
              /*
                setTimeout(() => {
                  try {
                    const value = onrejected(this.PromiseResult)
                    if (value instanceof Promise) {
                      value.then(resolve, reject)
                    } else {
                      resolve(value)
                    }
                  } catch (error) {
                    reject(error)
                  }
                })
              */
              _common.call(this, onrejected)
            } else {
              // å¦‚æœ executor æ‰§è¡Œå™¨å‡½æ•°å½“ä¸­æ‰§è¡Œçš„æ˜¯å¼‚æ­¥ç¨‹åº
              // å½“ç»“æœè¿˜æ²¡æœ‰å®Œå…¨æ‰§è¡Œå®Œæ¯•ï¼ˆæ—¶é—´è¿˜æ²¡æœ‰å®Œå…¨åˆ°è¾¾ï¼‰
              // æ­¤æ—¶ Promise å®ä¾‹åŒ–å¯¹è±¡çš„çŠ¶æ€ä¸º pending çš„çŠ¶æ€
              this.callbackFn = {
                // æ·»åŠ ä¸¤ä¸ªå›è°ƒå‡½æ•°
                onfulfilled: _common.bind(this, onfulfilled),
                onrejected: _common.bind(this, onrejected),
              }
            }
          })
        },
      })
      window.Promise = Promise
    })(window)
  </script>
  <script>
    let p = new Promise((resolve, reject) => {
      setTimeout(() => {
        resolve(100)
      }, 100)
      // throw new Error('å¼‚å¸¸')
      // reject('error')
      // resolve(100)
    })
    const p2 = p.then()
    console.log('%c Line:106 ğŸ© p2', 'font-size:16px;color:#33a5ff', p)
  </script>
</html>
