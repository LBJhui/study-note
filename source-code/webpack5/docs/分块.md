```javascript
// 配置打包输出优化 (代码分割, 模块合并 等优化策略)
optimization: {
    splitChunks: {
      chunks: 'all', // 对同步和异步模块都进行分割
      maxAsyncRequests: 10, // 每个异步加载模块最多的并行请求数
      maxInitialRequests: 10, // 一个入口的最大并行请求数
      cacheGroups: {
        vendor: {
          // 第三方依赖库
          test: /[\/]node_modules[\/]/, // 匹配 node_modules 目录下的模块
          name: 'vendor', // 模块名称
          priority: 20, // 优先级 数字越大优先级越高
          enforce: true, // 强制执行
          reuseExistingChunk: true, // 复用已经存在的 chunk
        },
        common: {
          // 公共模块
          test: /[\/]common|widgets[\/]/,
          name: 'common',
          minChunks: 2, // 最少引用次数
          minSize: 1, // 最小分割文件大小 字节为单位
          priority: 10,
          reuseExistingChunk: true,
        },
      },
    },
    // 将 webpack 运行时的代码单独抽离出来 runtime.js
    runtimeChunk: true,
}
```

HMR 相关的 Webpack 配置

```javascript
entry: {
    // 注入代码
    'entry1': [
        path.resolve(process.cwd(), './app/entry1/entry1.js'),
        `webpack-hot-middleware/client?path=http://${DEV_SERVER_CONFIG.HOST}:${DEV_SERVER_CONFIG.PORT}/${DEV_SERVER_CONFIG.HMR_PATH}?timeout=${DEV_SERVER_CONFIG.TIMEOUT}&reload=true`,
    ],
    'entry2': [
        path.resolve(process.cwd(), './app/entry2/entry2.js'),
        `webpack-hot-middleware/client?path=http://${DEV_SERVER_CONFIG.HOST}:${DEV_SERVER_CONFIG.PORT}/${DEV_SERVER_CONFIG.HMR_PATH}?timeout=${DEV_SERVER_CONFIG.TIMEOUT}&reload=true`,
    ]
},
output: {
    filename: 'js/[name]_[chunkhash:8].bundle.js',
    path: path.resolve(process.cwd(), './app/public/dist/dev/'), // 输出文件存储路径
    publicPath: `http://${DEV_SERVER_CONFIG.HOST}:${DEV_SERVER_CONFIG.PORT}/public/dist/dev/`, // 外部资源文件公共路径
},
// 开发阶段插件
plugins: [
    // 实现热模块替换
    // 模块热替换允许在运行时更新各种模块
    new webpack.HotModuleReplacementPlugin({
      multiStep: false,
    }),
]
```

监听文件改动：webpack-dev-middleware

通知文件更新：webpack-hot-middleware

```javascript
// 本地开发启动 devServer 配置
const express = require('express')
const path = require('path')
const webpack = require('webpack')
const consoler = require('consoler')
const devMiddleware = require('webpack-dev-middleware')
const hotMiddleware = require('webpack-hot-middleware')
const webpackDevConfig = require('./config/webpack.dev.js')
const app = express()

// 从 webpack.dev.js 获取 webpack 配置 和 devServer 配置
const { webpackConfig, DEV_SERVER_CONFIG } = webpackDevConfig

const compiler = webpack(webpackConfig)

// 指定静态文件目录
app.use(express.static(path.join(__dirname, '../public/dist')))
// 引用 webpack-dev-middleware 中间件  (监控文件改动)
app.use(
  devMiddleware(compiler, {
    // 落地文件: 生成的 tpl
    writeToDisk: (filePath) => filePath.endsWith('.tpl'),
    // 资源路径
    publicPath: webpackConfig.output.publicPath,

    // headers 配置
    headers: {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Method': 'GET,POST,PUT,DELETE,OPTIONS,PATCH',
      'Access-Control-Allow-Headers': 'X-Requested-With,content-type,Authorization'
    },
    // 控制台输出
    stats: {
      colors: true
    }
  })
)
// 引用 webpack-hot-middleware 中间件  (热更新通讯)
app.use(
  hotMiddleware(compiler, {
    log: () => {},
    path: `/${DEV_SERVER_CONFIG.HMR_PATH}`
  })
)

consoler.info('请等待 webpack 初次构建完成提示...')

// 启动 devServer
const port = DEV_SERVER_CONFIG.PORT
app.listen(port, () => {
  console.log(`app listening on port ${port}`)
})
```

压缩/优化
生产环境
css
多线程处理 happypack

抽离公共部分 MiniCssExtractPlugin

压缩 CSSMinimizerPlugin

```javascript
// 多线程 build 设置
const happypackCommonConifig = {
debug: false,
threadPool: HappyPack.ThreadPool({ size: os.cpus().length }),
};

module: {
    rules: [{
        test: /.css$/,
        use: [MiniCssExtractPlugin.loader, 'happypack/loader?id=css'],
    }]
},

plugins: [{
    // 提取 css 的公共部分
    new MiniCssExtractPlugin({
      chunkFilename: 'css/[name]_[chunkhash:8].bundle.css', // 非入口 chunk 的名称
    }),
    // 优化并压缩 css 资源
    new CSSMinimizerPlugin(),
    // 多线程打包 CSS，加快打包速度
    new HappyPack({
      ...happypackCommonConifig,
      id: 'css',
      loaders: [
        {
          path: 'css-loader',
          options: {
            importLoaders: 1,
          },
        },
      ],
    }),
}]
```

js

多线程处理 loader happypack

并行压缩 TerserWebpackPlugin

```javascript
module: {
    rules: [{
        test: /.js$/,
        include: [
          // 只对业务代码进行 babel 处理，加快 webpack 打包速度
          path.resolve(process.cwd(), './app/pages'),
        ],
        use: ['happypack/loader?id=js'],
    }]
},
plugins: [
    // 多线程打包 JS，加快打包速度
    new HappyPack({
      ...happypackCommonConifig,
      id: 'js',
      loaders: [
        `babel-loader?${JSON.stringify({
          presets: ['@babel/preset-env'],
          plugins: [
            '@babel/plugin-transform-runtime'
          ],
        })}`,
      ],
    }),
]
optimization: {
    // 使用 TerserPlugin 的并发和缓存，提升压缩阶段性能
    // 清除 console.log
    minimize: true,
    minimizer: [
      new TerserWebpackPlugin({
        parallel: true, // 利用多核 CPU 进行压缩
        cache: true, // 启动缓存来加速构建过程
        terserOptions: {
          compress: {
            drop_console: true, // 删除所有的 `console` 语句
          },
        },
      }),
    ],
}
```

其他优化
打包前清空目录

```javascript
plugins: [
  // 每次 build 前，清空 public/dist 目录
  new CleanWebpackPlugin(['public/dist'], {
    root: path.resolve(process.cwd(), './app/'),
    exclude: [],
    verbose: true,
    dry: false
  })
]
```
